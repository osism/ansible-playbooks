---
###
# This playbook creates LVM volumes for Ceph and generates host inventory
# inside a OSISM-deployed Ceph cluster:
# As an operator you provide the following config and the playbook will
# configure LVM (create PVs, VGs, LVs and ceph lvm_volumes config) for you:
#
# This playbook can be used to create LVMs for deploying Ceph and
# create a lvm_volumes configuration for ceph-ansible to actually deploy
# the OSDs later.
###

- name: Ceph configure LVM
  hosts:
    - ceph-osd
  gather_facts: true
  force_handlers: true
  strategy: linear
  serial: 1
  vars:
    _ceph_configure_lvm_config_path: "/tmp/"
    _ceph_configure_lvm_config_file: "ceph-lvm-configuration.yml"
  vars_prompt:
    - name: ireallymeanit
      prompt: >
        Are you sure you want to configure Ceph LVM?
        Do you want to continue?
      default: 'no'
      private: false
  tasks:
    - name: Exit playbook, if user did not mean to configure LVM
      ansible.builtin.fail:
        msg: >
          "Exiting ceph-configure-lvm-volumes playbook, LVM was NOT configured.
           To configure Ceph LVM the node, either say 'yes' on the prompt or
           or use `-e ireallymeanit=yes` on the command line when
           invoking the playbook"
      when: ireallymeanit != 'yes'

    - name: Get extra vars for Ceph configuration
      run_once: true
      ansible.builtin.include_vars:
        file:
          "{{ configuration_directory }}\
          /environments/ceph/configuration.yml"
        name: _osds_configuration_vars
      delegate_to: "{{ groups['manager'][0] }}"

    - name: Ceph configure LVM
      block:
        - name: Get block devices
          ansible.builtin.set_fact:
            block_devices: "{{ hostvars[inventory_hostname].ansible_devices }}"

        - name: Print ceph_osd_devices
          ansible.builtin.debug:
            var: ceph_osd_devices

        - name: Print ceph_osd_devices_buffer_space_percent
          ansible.builtin.debug:
            var: ceph_osd_devices_buffer_space_percent

        - name: Set UUIDs for OSD VGs/LVs
          ansible.builtin.set_fact:
            _ceph_osd_devices: >-
              {{
                _ceph_osd_devices|default([]) +
                [
                  item|ansible.builtin.combine(
                  {
                    'osd_lvm_uuid':
                    lookup(
                      'community.general.random_string',
                        length = 64
                    )|ansible.builtin.to_uuid
                  }
                  )
                ]
              }}
          with_items: "{{ ceph_osd_devices }}"
          when: item.osd_lvm_uuid is not defined

        - name: Overwrite ceph_osd_devices
          ansible.builtin.set_fact:
            ceph_osd_devices: "{{ _ceph_osd_devices }}"

        - name: Print ceph_osd_devices
          ansible.builtin.debug:
            var: ceph_osd_devices

        - name: Get WAL PVs
          ansible.builtin.set_fact:
            ceph_wal_devices: >-
              {{
                (ceph_wal_devices|default([]) + [ item.wal_pv ])|
                ansible.builtin.unique
              }}
          with_items: "{{ ceph_osd_devices }}"
          when: item.wal_pv is defined

        - name: Get DB PVs
          ansible.builtin.set_fact:
            ceph_db_devices: >-
              {{
                (ceph_db_devices|default([]) + [ item.db_pv ])|
                ansible.builtin.unique
              }}
          with_items: "{{ ceph_osd_devices }}"
          when: item.db_pv is defined

        - name: Get shared DB/WAL PVs
          ansible.builtin.set_fact:
            ceph_db_wal_devices: >-
              {{
                ceph_wal_devices|default([])|
                ansible.builtin.intersect(ceph_db_devices|default([]))
              }}

        - name: Remove shared DB/WAL PVs from WAL/DB device list
          ansible.builtin.set_fact:
            ceph_db_devices: >-
              {{
                ceph_db_devices|default([])|
                ansible.builtin.difference(ceph_db_wal_devices)
              }}
            ceph_wal_devices: >-
              {{
                ceph_wal_devices|default([])|
                ansible.builtin.difference(ceph_db_wal_devices)
              }}

        - name: Generate WAL VG names
          ansible.builtin.set_fact:
            _ceph_wal_devices: >-
              {{
              _ceph_wal_devices|default([]) +
              [
                {
                  "wal_pv": item,
                  "wal_vg_name":
                  "ceph-wal-" + (
                    lookup(
                      'community.general.random_string',
                      length = 64
                    )|ansible.builtin.to_uuid
                  )
                }
              ]
              }}
          loop: "{{ ceph_wal_devices }}"

        - name: Generate DB VG names
          ansible.builtin.set_fact:
            _ceph_db_devices: >-
              {{
              _ceph_db_devices|default([]) +
              [
                {
                  "db_pv": item,
                  "db_vg_name":
                  "ceph-db-" + (
                    lookup(
                      'community.general.random_string',
                      length = 64
                    )|ansible.builtin.to_uuid
                  )
                }
              ]
              }}
          loop: "{{ ceph_db_devices }}"

        - name: Generate shared DB/WAL VG names
          ansible.builtin.set_fact:
            _ceph_db_wal_devices: >-
              {{
              _ceph_db_wal_devices|default([]) +
              [
                {
                  "db_wal_pv": item,
                  "db_wal_vg_name":
                  "ceph-db-wal-" + (
                    lookup(
                      'community.general.random_string',
                      length = 64
                    )|ansible.builtin.to_uuid
                  )
                }
              ]
              }}
          loop: "{{ ceph_db_wal_devices }}"

        - name: Set vars
          ansible.builtin.set_fact:
            ceph_wal_devices: "{{ _ceph_wal_devices | default([]) }}"
            ceph_db_devices: "{{ _ceph_db_devices | default([]) }}"
            ceph_db_wal_devices: "{{ _ceph_db_wal_devices | default([]) }}"

        - name: Print WAL devices
          ansible.builtin.debug:
            var: ceph_wal_devices

        - name: Print DB devices
          ansible.builtin.debug:
            var: ceph_db_devices

        - name: Print shared DB/WAL devices
          ansible.builtin.debug:
            var: ceph_db_wal_devices

      # condition for block
      when: ceph_osd_devices is defined

    - name: Generate config data
      ansible.builtin.set_fact:
        _ceph_configure_lvm_config_data: >-
           Nothing here as of yet,
           this should contain config data
           for node {{ inventory_hostname }}
      changed_when: true
      notify:
        - Write configuration file

  # - name: Print block devices (verbose)
  #   ansible.builtin.debug:
  #     msg: "{{ item.key }} is a {{ item.value.vendor|default('UNKNOWN') }} {{ item.value.model|default('UNKNOWN') }} with a capacity of {{ item.value.sectors|int * item.value.sectorsize|int }}"
  #   with_dict: "{{ block_devices }}"

  handlers:
    - name: Write configuration file
      run_once: true
      ansible.builtin.template:
        src: "templates/ceph-configure-lvm-volumes.yml.j2"
        dest: >-
          {{
             _ceph_configure_lvm_config_path +
             inventory_hostname +
             "-" +
             _ceph_configure_lvm_config_file
          }}
        mode: "u=rw,g=r,o=r"
      delegate_to: "{{ groups['manager'][0] }}"
