---
- name: Upgrade k3s cluster
  hosts: localhost
  connection: local

  tasks:
    - name: Get k3s installed version
      ansible.builtin.command: k3s --version
      register: k3s_version_output
      changed_when: false

    - name: Set k3s installed version
      ansible.builtin.set_fact:
        installed_k3s_version: "{{ k3s_version_output.stdout_lines[0].split(' ')[2] }}"

    - name: Update node only if needed
      when: installed_k3s_version is version(k3s_version, '<')
      block:
        - name: Download k3s binary x64
          ansible.builtin.get_url:
            url: https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s
            checksum: sha256:https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-amd64.txt
            dest: /usr/local/bin/k3s
            owner: root
            group: root
            mode: 0755

        - name: Enable and check K3s service
          ansible.builtin.systemd_service:
            name: k3s
            daemon_reload: true
            state: restarted
            enabled: true
