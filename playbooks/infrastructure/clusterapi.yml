---
- name: Initialize or upgrade the CAPI management cluster
  hosts: localhost
  connection: local

  vars:
    capi_version: 1.6.2
    capo_version: 0.9.0

  tasks:
    - name: Initialize or upgrade the CAPI management cluster
      ansible.builtin.shell:
        set -o pipefail

        export KUBECONFIG=/share/kubeconfig
        export EXP_CLUSTER_RESOURCE_SET=true
        export CLUSTER_TOPOLOGY=true

        if [[ $(kubectl get ns capi-system -o json | jq .status.phase -r) == "Active" ]]; then
          clusterctl upgrade apply \
            --core cluster-api:v{{ capi_version }} \
            --bootstrap kubeadm:v{{ capi_version }} \
            --control-plane kubeadm:v{{ capi_version }} \
            --infrastructure openstack:v{{ capo_version }};
        else
          clusterctl init \
            --core cluster-api:v{{ capi_version }} \
            --bootstrap kubeadm:v{{ capi_version }} \
            --control-plane kubeadm:v{{ capi_version }} \
            --infrastructure openstack:v{{ capo_version }};
        fi
      args:
        executable: /bin/bash
      register: result
      changed_when: "'Your management cluster has been initialized successfully' in result.stdout"
